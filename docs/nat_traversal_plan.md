# NAT対応拡張計画

本計画では、分散ノードの接続性拡張を「機能カテゴリ（NAT検出・穴あけ・RPC拡張・libp2p互換・導入手順）」で分割し、互いに重複しないMECE構成で整理する。

## NAT検出
- 方針基準: 外部アドレス把握とNAT種別推定を担う処理に限定
- 既存クレート活用: `stun` もしくは `webrtc-rs` をTokioタスクに組み込み、`Node::start()`直後に外部IP/ポートを取得。
- 自前実装: RFC 5389準拠のSTUNバインドリクエストをRustで組み立て、`NatType`列挙体で結果を表現。Fingerprintや認証を正確に扱う必要があり保守コストが高い。
- NATタイプ判別: 複数STUNサーバを切り替えてマッピング変化を観測し、フルコーン／リストリクテッド／ポートリストリクテッド／シンメトリックを判定。判定ロジックは単体テスト可能な独立モジュールに分離。
- シンメトリックNAT対応: STUN単独では不可。TURNリレー（`webrtc-rs`のICE/Relay部品など）または中継ノードでの代理通信が必須。

## ホールパンチ
- 方針基準: NAT情報を活用したP2Pセッション確立処理に限定
- UDP中心: ブートストラップノードを調整役に同時送信を行い、`tokio::time::timeout` と `tokio::select!` で再送制御とタイミング調整を実装。
- TCP対応: 成功率が低いためUDP優先。必要時はUPnP/NAT-PMP（`igd` crate等）でポートマッピングを試み、失敗時はリレーへフォールバック。
- 失敗時処理: TURNリレー接続またはフェデレーション内中継ノードに切り替える設計とし、`Connectivity`列挙体で直接接続／ホールパンチ／リレーを明示する。

## カスタムRPCストリーミング
- 方針基準: Kademlia標準RPCを拡張しストリーム志向の要求/応答を扱う部分に限定
- プロトコル拡張: メッセージに`stream_id`と`chunk_seq`を追加し、多段レスポンスを許容。互換性維持のためオプションフィールド扱いとする。
- Rust実装: `tokio::sync::mpsc`や`tokio_stream`を使い、送信側は非同期Iterator、受信側は`Stream`トレイトで逐次処理。`RpcResponse`列挙体で単発返信とストリーム返信を統合。
- 信頼性: UDP利用時は軽量ACK/NACKで再送制御、リレー経由時はTCPへ切替可能なトランスポート抽象を構築。

## libp2p互換
- 方針基準: libp2pエコシステムとの相互運用に関わる事項に限定
- 直接移植: `rust-libp2p`のKademliaモジュール採用で最短実現。ただし既存ストレージ・バックグラウンドタスク設計を置き換える必要がある。
- 互換層追加: 現行RPC上にlibp2p互換フォーマット（`PeerId`/`Multiaddr`）を実装し、Feature Flagで切替。段階的に相互接続→互換テスト→完全移行を目指す。
- 既存libp2p機能活用: AutoNATやAutoRelayがNAT/リレー課題を解決できるが、依存関係とバイナリサイズ増を許容する判断が必要。

## 導入ステップ
1. STUN/TURN PoC: 既存クレートで外部アドレス検出タスクを実装し、`NatType`を返すAPIを追加。
2. ホールパンチ実装: NATタイプに応じた接続戦略を`Connectivity`抽象で切替え、失敗時はリレー候補を返す。
3. ストリーミングRPC拡張: プロトコル定義とTokioストリーム実装を追加し、値複数返却やログ配信などで検証。
4. リレー/シンメトリック対策: TURN連携または専用中継ノードの仕様を固め、テスト網で耐久確認。
5. libp2p互換評価: 互換層を実装し、libp2pノードとの相互運用テストを行った上で採用可否を決定。
