# 悪意ノード対策計画

## 概要

Kademlia DHT ネットワークにおける悪意あるノードや不正行為への対策を計画し、ネットワークの信頼性とセキュリティを向上させる。

## 脅威モデル

### 1. Sybil 攻撃
- **説明**: 単一の攻撃者が複数の偽ノードID を生成してネットワークに影響を与える
- **影響**: ルーティングテーブルの汚染、特定ノードの孤立化、データアクセスの制御
- **リスクレベル**: 🔴 高

### 2. Eclipse 攻撃
- **説明**: ターゲットノードのルーティングテーブルを攻撃者のノードで埋め尽くし、ネットワークから孤立させる
- **影響**: データアクセスの遮断、不正データの注入
- **リスクレベル**: 🔴 高

### 3. ルーティング汚染
- **説明**: 不正なルーティング情報を提供し、クエリを誤った方向に誘導
- **影響**: データ検索の失敗、ネットワーク効率の低下
- **リスクレベル**: 🟡 中

### 4. 不正データ注入
- **説明**: 誤ったデータやスパムデータをネットワークに保存
- **影響**: データ整合性の低下、ストレージの浪費
- **リスクレベル**: 🟡 中

### 5. DoS 攻撃
- **説明**: 大量のリクエストを送信してノードやネットワーク全体を過負荷にする
- **影響**: サービス停止、ネットワークパフォーマンスの低下
- **リスクレベル**: 🟡 中

## 対策カテゴリ（MECE構造）

### A. ノード識別・検証

#### A-1. ノードID検証
- **目的**: Sybil攻撃の難易度を上げる
- **方式**:
  - Proof-of-Work (PoW) ベースのID生成（計算コストを課す）
  - クライアントパズル（接続時に解決を要求）
  - IP制限（同一IPからの複数ノード制限）
- **実装難易度**: 中

#### A-2. ノード署名・認証
- **目的**: ノードの真正性を保証
- **方式**:
  - 公開鍵暗号によるメッセージ署名
  - ノードIDと公開鍵の紐付け検証
  - 証明書チェーン（オプション）
- **実装難易度**: 中〜高

### B. レピュテーション管理

#### B-1. 行動ベース評価
- **目的**: ノードの信頼性を時間経過とともに評価
- **評価項目**:
  - 応答率（PING、FIND_NODE、FIND_VALUE への応答成功率）
  - 応答時間（タイムアウト頻度）
  - データ整合性（提供データの正確性）
  - 稼働時間（長時間稼働ノードを優先）
- **実装難易度**: 中

#### B-2. スコアリング・ランク付け
- **目的**: 評価に基づく優先度管理
- **方式**:
  - 0-100のスコアでノードを評価
  - スコア閾値以下のノードは k-bucket から優先的に退避
  - ルーティング選択時に高スコアノードを優先
- **実装難易度**: 中

### C. データ整合性保証

#### C-1. 複数ノード検証
- **目的**: 単一ノードの不正データを検出
- **方式**:
  - FIND_VALUE 時に複数ノード（k個）から取得し多数決
  - データハッシュの一致確認
  - 不一致時の再試行とレピュテーション減点
- **実装難易度**: 中

#### C-2. データ署名
- **目的**: データ発行者の真正性保証
- **方式**:
  - データに発行者の署名を付与
  - 取得時に署名を検証
  - 公開鍵の信頼チェーン構築（オプション）
- **実装難易度**: 高

### D. ネットワーク構造強化

#### D-1. ルーティング多様性
- **目的**: Eclipse攻撃を困難にする
- **方式**:
  - IPサブネット多様性の保証（同一/24から最大n個まで）
  - k-bucket内で異なるAS（自律システム）を優先
  - ランダムウォークによる定期的な新規ノード発見
- **実装難易度**: 中〜高

#### D-2. 冗長性の向上
- **目的**: データ可用性の向上
- **方式**:
  - レプリケーション係数の増加（k=20 → より大きな値）
  - 定期的な再公開頻度の調整
  - 重要データの優先レプリケーション
- **実装難易度**: 低

### E. リクエスト制御

#### E-1. レート制限
- **目的**: DoS攻撃の緩和
- **方式**:
  - IPベース／ノードIDベースのレート制限
  - トークンバケットアルゴリズム
  - 異常検知時の一時ブロック
- **実装難易度**: 中

#### E-2. タイムアウト最適化
- **目的**: 遅いノードやタイムアウト攻撃への耐性
- **方式**:
  - 適応的タイムアウト（応答履歴に基づく動的調整）
  - 並列クエリで高速応答を優先
  - タイムアウト頻発ノードのレピュテーション減点
- **実装難易度**: 低〜中

## 実装優先順位

### 短期（Phase 1: 1-2週間）

**目標**: 最小コストで最大効果の対策を実装

1. **レート制限（E-1）**
   - 実装: `src/network/udp.rs` にIPベースのレート制限を追加
   - 効果: DoS攻撃の即座の緩和

2. **応答率ベースの評価（B-1の一部）**
   - 実装: `src/routing/k_bucket.rs` にノード応答成功率の記録を追加
   - 効果: 不安定ノードの自動退避

3. **タイムアウト最適化（E-2）**
   - 実装: `src/protocol/mod.rs` の既存タイムアウトを応答履歴ベースに変更
   - 効果: ネットワーク効率の向上

### 中期（Phase 2: 1-2ヶ月）

**目標**: レピュテーションシステムとデータ検証の基盤構築

4. **包括的レピュテーションシステム（B-1, B-2）**
   - 実装: `src/routing/reputation.rs` 新規モジュール作成
   - 統合: RoutingTable、KBucket との連携
   - 効果: 悪意ノードの自動排除

5. **複数ノード検証（C-1）**
   - 実装: `src/protocol/mod.rs` の `find_value` でk個のノードから取得し検証
   - 効果: 不正データの検出と除外

6. **ルーティング多様性（D-1の一部）**
   - 実装: `src/routing/k_bucket.rs` にIPサブネット多様性チェックを追加
   - 効果: Eclipse攻撃の難易度向上

### 長期（Phase 3: 3ヶ月以上）

**目標**: 高度なセキュリティ機能と暗号学的保証

7. **ノードID検証 PoW（A-1）**
   - 実装: `src/node_id/mod.rs` に PoW ベースのID生成を追加
   - 効果: Sybil攻撃の経済コスト増加

8. **メッセージ署名・認証（A-2）**
   - 実装: `src/protocol/mod.rs` に署名フィールドと検証ロジックを追加
   - 依存: `ed25519-dalek` や `ring` などの暗号ライブラリ
   - 効果: なりすまし防止、メッセージ改ざん検出

9. **データ署名（C-2）**
   - 実装: `src/storage/mod.rs` にデータ署名の保存と検証を追加
   - 効果: データ発行者の真正性保証

10. **AS多様性とランダムウォーク（D-1完全版）**
    - 実装: 外部IPGeolocation API連携、定期的なランダムノード探索
    - 効果: ネットワークトポロジーの強化

## 設計上の考慮事項

### トレードオフ

| 対策 | メリット | デメリット |
|------|---------|-----------|
| PoW ベースID | Sybil攻撃コスト増 | 正当なノードの参加コスト増 |
| 署名検証 | 強固な認証 | 計算オーバーヘッド、複雑性増 |
| 複数ノード検証 | データ整合性向上 | ネットワークトラフィック増加 |
| レート制限 | DoS緩和 | 正当なトラフィック制限のリスク |
| レピュテーション | 悪意ノード排除 | コールドスタート問題、実装複雑性 |

### 互換性

- 後方互換性は不要（CLAUDE.md方針）
- ただし、段階的な導入が可能な設計を推奨（例：署名はオプショナルから必須へ移行）

### パフォーマンス

- 暗号処理は非同期で実装し、ネットワークスレッドをブロックしない
- レピュテーションスコアはメモリ効率を考慮（LRUキャッシュなど）
- レート制限はロックフリーまたは最小限のロックで実装

## 検証方法

### テストシナリオ

1. **Sybil攻撃シミュレーション**
   - 100個の偽ノードを生成してネットワーク参加を試行
   - PoW実装後に生成コストを測定

2. **Eclipse攻撃シミュレーション**
   - ターゲットノードに対して攻撃者ノード群でFIND_NODEレスポンスを返す
   - 多様性チェックで攻撃が緩和されることを確認

3. **不正データ注入テスト**
   - 複数の攻撃者ノードが異なる値を返すシナリオ
   - 多数決検証で正しいデータが選択されることを確認

4. **DoSストレステスト**
   - 1秒間に1000リクエストを送信
   - レート制限で適切にブロックされることを確認

### メトリクス

- 攻撃成功率（対策前後で比較）
- ネットワークスループット（オーバーヘッドの測定）
- レピュテーションスコアの収束時間
- 誤検知率（正当なノードが排除される頻度）

## 実装ロードマップ

```
Week 1-2:  Phase 1 実装（レート制限、応答率評価、タイムアウト最適化）
Week 3-4:  Phase 1 テスト・検証
Week 5-8:  Phase 2 実装（レピュテーションシステム、複数ノード検証、多様性チェック）
Week 9-10: Phase 2 テスト・検証
Week 11+:  Phase 3 実装（PoW、署名、高度な機能）
```

## 参考文献・関連仕様

- [Original Kademlia Paper](https://pdos.csail.mit.edu/~petar/papers/maymounkov-kademlia-lncs.pdf)
- [S/Kademlia: A Practicable Approach Towards Secure Key-Based Routing](https://ieeexplore.ieee.org/document/4447808)
- IPFS DHT Security Considerations
- BitTorrent DHT BEP-0042 (Node ID Restriction)

## 次のステップ

1. Phase 1 の実装タスクを Issue として作成
2. レピュテーションシステムの詳細設計を別ドキュメントで作成
3. テストフレームワークの拡張（攻撃シミュレーション機能）